<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro com Imagem</title>
  <link rel="stylesheet" href="main.css" />
  <!-- Font Awesome (substitua SEU_CODIGO_AQUI pelo seu kit) -->
  <script src="https://kit.fontawesome.com/SEU_CODIGO_AQUI.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Botão SAIR -->
  <form action="index.html">
    <input type="submit" value="SAIR" class="sair" />
  </form>

  <div class="container">
    <!-- Botão de alternar modo escuro/claro -->
    <button class="toggle-mode" id="toggleModoBtn" aria-pressed="false">
      🌙 <span class="texto-modo">Modo Escuro</span>
    </button>

    <h2>Reportar Um Problema</h2>
    <form id="formPessoa" enctype="multipart/form-data">
      <!-- Campo Nome com botão Anônimo -->
      <div class="field-group">
        <input
          type="text"
          name="nome"
          id="inputNome"
          placeholder="Nome"
          required
        />
        <button type="button" class="btn-anonimo" id="btnAnonimo">
          Anônimo?
        </button>
      </div>

      <!-- Campo Relato -->
      <input type="text" name="relato" placeholder="Relato" required />

      <!-- Upload de arquivo -->
      <label class="custom-file-upload">
        <input
          type="file"
          name="imagem"
          accept="image/*"
          id="inputImagem"
          required
        />
        <i class="fas fa-upload"></i> Escolher imagem
      </label>

      <!-- Botão que abre a câmera -->
      <button type="button" class="camera-btn" id="btnAbrirCamera">
        📸 Tirar foto com câmera
      </button>

      <!-- Preview da imagem (selecionada pelo input ou capturada pela câmera) -->
      <div class="preview-container" id="previewContainer" style="display: none;">
        <img id="previewImagem" alt="Preview da imagem" />
        <button type="button" class="btn-remover" id="btnRemoverImagem">
          ❌ Remover imagem
        </button>
      </div>

      <button type="submit" class="btn-submit">Cadastrar</button>
    </form>
  </div>

  <!-- Pop-up da câmera -->
  <div
    id="cameraPopup"
    class="camera-popup"
    style="display: none;"
    aria-hidden="true"
  >
    <div class="camera-content">
      <button type="button" class="close-popup" id="btnFecharCamera">
        ✖
      </button>
      <video id="cameraVideo" autoplay playsinline></video>
      <button type="button" class="camera-btn" id="btnCapturarFoto">
        📸 Capturar
      </button>
    </div>
  </div>

  <div class="container">
    <h2>Relatos Registrados</h2>
    <ul id="listaPessoas"></ul>
  </div>

  <script>
    // Referências de elementos
    const toggleModoBtn = document.getElementById("toggleModoBtn");
    const form = document.getElementById("formPessoa");
    const lista = document.getElementById("listaPessoas");

    const inputNome = document.getElementById("inputNome");
    const btnAnonimo = document.getElementById("btnAnonimo");
    const inputImagem = document.getElementById("inputImagem");
    const previewContainer = document.getElementById("previewContainer");
    const previewImagem = document.getElementById("previewImagem");
    const btnRemoverImagem = document.getElementById("btnRemoverImagem");

    const btnAbrirCamera = document.getElementById("btnAbrirCamera");
    const cameraPopup = document.getElementById("cameraPopup");
    const btnFecharCamera = document.getElementById("btnFecharCamera");
    const cameraVideo = document.getElementById("cameraVideo");
    const btnCapturarFoto = document.getElementById("btnCapturarFoto");

    let stream = null;

    // 1) Alternar modo escuro/claro
    toggleModoBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleModoBtn.setAttribute("aria-pressed", isDark);
      toggleModoBtn.querySelector(".texto-modo").textContent = isDark
        ? "Modo Claro"
        : "Modo Escuro";
    });

    // 2) Botão "Anônimo": torna o campo somente leitura (readonly)
    btnAnonimo.addEventListener("click", () => {
      if (!inputNome.readOnly) {
        // Define "Anônimo" e torna readonly
        inputNome.value = "Anônimo";
        inputNome.readOnly = true;
        btnAnonimo.textContent = "Desfazer Anônimo";
        inputNome.classList.add("readonly-style");
      } else {
        // Remove valor e readonly
        inputNome.value = "";
        inputNome.readOnly = false;
        btnAnonimo.textContent = "Anônimo?";
        inputNome.classList.remove("readonly-style");
        inputNome.focus();
      }
    });

    // 3) Ao selecionar arquivo manualmente, remova a classe de espelhamento
    inputImagem.addEventListener("change", () => {
      previewContainer.classList.remove("invert-camera");

      const file = inputImagem.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImagem.src = e.target.result;
          previewContainer.style.display = "flex";
        };
        reader.readAsDataURL(file);
      }
    });

    // 4) Botão de remover imagem: limpa preview e arquivo
    btnRemoverImagem.addEventListener("click", () => {
      inputImagem.value = "";
      previewImagem.src = "";
      previewContainer.style.display = "none";
      previewContainer.classList.remove("invert-camera");
    });

    // 5) Envio do formulário
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Garante que, se estiver em modo Anônimo (readonly), o campo já contém "Anônimo"
      const formData = new FormData(form);
      try {
        await fetch("http://localhost:3000/upload", {
          method: "POST",
          body: formData,
        });
        form.reset();
        btnRemoverImagem.click();

        // Se o campo Nome estava em modo Anônimo, restaurar ao estado inicial
        if (inputNome.readOnly) {
          inputNome.readOnly = false;
          inputNome.value = "";
          inputNome.classList.remove("readonly-style");
          btnAnonimo.textContent = "Anônimo?";
        }

        carregarPessoas();
      } catch (err) {
        console.error("Erro ao enviar dados:", err);
        alert("Ocorreu um erro ao cadastrar. Tente novamente.");
      }
    });

    // 6) Carregar lista de pessoas/relatos
    async function carregarPessoas() {
      try {
        const res = await fetch("http://localhost:3000/pessoas");
        let pessoas = await res.json();

        pessoas = pessoas
          .map((p) => {
            const pontos = parseInt(localStorage.getItem("pontos_" + p.id)) || 0;
            return { ...p, pontos };
          })
          .sort((a, b) => b.pontos - a.pontos);

        lista.innerHTML = "";

        pessoas.forEach((p) => {
          const li = document.createElement("li");
          li.classList.add("card-pessoa");
          li.innerHTML = `
            <div class="votacao">
              <button class="up btn-voto" data-id="${p.id}" aria-label="Curtir">▲</button>
              <span class="score" id="score_${p.id}">${p.pontos}</span>
              <button class="down btn-voto" data-id="${p.id}" aria-label="Descurtir">▼</button>
            </div>
            <strong>${p.nome}</strong>
            <img src="data:image/jpeg;base64,${p.imagem}" alt="Imagem de ${p.nome}" />
            <p>${p.relato}</p>
            <button class="delete-btn" data-id="${p.id}" aria-label="Excluir relato">🗑️ Excluir</button>
          `;
          lista.appendChild(li);
        });

        // Eventos de votação
        document.querySelectorAll(".btn-voto").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            const key = "pontos_" + id;
            let pontos = parseInt(localStorage.getItem(key)) || 0;
            pontos += e.currentTarget.classList.contains("up") ? 1 : -1;
            if (pontos < 0) pontos = 0;
            localStorage.setItem(key, pontos);
            carregarPessoas();
          });
        });

        // Eventos de exclusão
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (confirm("Tem certeza que deseja excluir este cadastro?")) {
              await fetch(`http://localhost:3000/excluir/${id}`, {
                method: "DELETE",
              });
              localStorage.removeItem("pontos_" + id);
              carregarPessoas();
            }
          });
        });
      } catch (err) {
        console.error("Erro ao carregar lista:", err);
      }
    }

    // 7) Abrir pop-up da câmera
    btnAbrirCamera.addEventListener("click", async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraVideo.srcObject = stream;
        cameraPopup.style.display = "flex";
        cameraPopup.setAttribute("aria-hidden", "false");
      } catch (err) {
        alert("Erro ao acessar a câmera.");
        console.error(err);
      }
    });

    // 8) Fechar pop-up da câmera
    btnFecharCamera.addEventListener("click", () => {
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
        stream = null;
      }
      cameraPopup.style.display = "none";
      cameraPopup.setAttribute("aria-hidden", "true");
    });

    // 9) Capturar foto: desenha no canvas (espelha só se NÃO for Safari)
  btnCapturarFoto.addEventListener("click", () => {
  if (!stream) return;

  const canvas = document.createElement("canvas");
  canvas.width = cameraVideo.videoWidth;
  canvas.height = cameraVideo.videoHeight;
  const ctx = canvas.getContext("2d");

  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  // Se NÃO for Safari, espelha horizontalmente
  if (!isSafari) {
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
  }

  ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(
    (blob) => {
      const file = new File([blob], "foto.png", { type: "image/png" });
      const dt = new DataTransfer();
      dt.items.add(file);
      inputImagem.files = dt.files;

      // Preview
      previewImagem.src = URL.createObjectURL(blob);
      previewContainer.style.display = "flex";

      // Aplica classe invert-camera só se não for Safari (para manter coerência visual)
      if (!isSafari) {
        previewContainer.classList.add("invert-camera");
      } else {
        previewContainer.classList.remove("invert-camera");
      }

      // Fecha pop-up
      btnFecharCamera.click();
    },
    "image/png"
  );
});

    navigator.mediaDevices.getUserMedia({ video: true })
  .then(function(stream) {
    const video = document.querySelector('video');
    video.srcObject = stream;

    // Adiciona classe para espelhar no Safari (principalmente câmera frontal)
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isSafari) {
      video.classList.add('mirror');
    }
  })
  .catch(function(err) {
    console.error("Erro ao acessar a câmera:", err);
  });


    // 10) Inicializa a lista ao carregar a página
    window.addEventListener("DOMContentLoaded", carregarPessoas);
  </script>
</body>
</html>
