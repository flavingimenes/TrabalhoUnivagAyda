<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro com Imagem</title>
  <link rel="stylesheet" href="main.css" />
  <!-- Font Awesome (substitua SEU_CODIGO_AQUI pelo seu kit) -->
  <script src="https://kit.fontawesome.com/SEU_CODIGO_AQUI.js" crossorigin="anonymous"></script>
  <style>
    .preview-container img {
      max-width: 200px;
      margin-top: 10px;
    }
    li.card-pessoa {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      list-style: none;
    }
    .votacao {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .votacao .score {
      min-width: 24px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Bot√£o SAIR -->
  <form action="index.html">
    <input type="submit" value="SAIR" class="sair" />
  </form>

  <div class="container">
    <!-- Bot√£o de alternar modo escuro/claro -->
    <button class="toggle-mode" id="toggleModoBtn" aria-pressed="false">
      üåô <span class="texto-modo">Modo Escuro</span>
    </button>

    <h2>Reportar Um Problema</h2>
    <form id="formPessoa" enctype="multipart/form-data">
      <!-- Campo Nome com bot√£o An√¥nimo -->
      <div class="field-group">
        <input
          type="text"
          name="nome"
          id="inputNome"
          placeholder="Nome"
          required
        />
        <button type="button" class="btn-anonimo" id="btnAnonimo">
          An√¥nimo?
        </button>
      </div>

      <!-- Campo Relato -->
      <input type="text" name="relato" placeholder="Relato" required />

      <!-- NOVO: Campo Localiza√ß√£o -->
      <input
        type="text"
        name="localizacao"
        id="inputLocalizacao"
        placeholder="Localiza√ß√£o"
        required
      />

      <!-- Upload de arquivo -->
      <label class="custom-file-upload">
        <input
          type="file"
          name="imagem"
          accept="image/*"
          id="inputImagem"
          required
        />
        <i class="fas fa-upload"></i> Escolher imagem
      </label>

      <!-- Bot√£o que abre a c√¢mera -->
      <button type="button" class="camera-btn" id="btnAbrirCamera">
        üì∏ Tirar foto com c√¢mera
      </button>

      <!-- Preview da imagem (selecionada pelo input ou capturada pela c√¢mera) -->
      <div class="preview-container" id="previewContainer" style="display: none;">
        <img id="previewImagem" alt="Preview da imagem" />
        <button type="button" class="btn-remover" id="btnRemoverImagem">
          ‚ùå Remover imagem
        </button>
      </div>

      <button type="submit" class="btn-submit">Cadastrar</button>
    </form>
  </div>

  <!-- Pop-up da c√¢mera -->
  <div
    id="cameraPopup"
    class="camera-popup"
    style="display: none;"
    aria-hidden="true"
  >
    <div class="camera-content">
      <button type="button" class="close-popup" id="btnFecharCamera">
        ‚úñ
      </button>
      <video id="cameraVideo" autoplay playsinline></video>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button type="button" class="camera-btn" id="btnTrocarCamera">
          üîÑ Trocar C√¢mera
        </button>
        <button type="button" class="camera-btn" id="btnCapturarFoto">
          üì∏ Capturar
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Relatos Registrados</h2>
    <ul id="listaPessoas"></ul>
  </div>

  <script>
    // Refer√™ncias de elementos
    const toggleModoBtn = document.getElementById("toggleModoBtn");
    const form = document.getElementById("formPessoa");
    const lista = document.getElementById("listaPessoas");

    const inputNome = document.getElementById("inputNome");
    const btnAnonimo = document.getElementById("btnAnonimo");
    const inputLocalizacao = document.getElementById("inputLocalizacao");
    const inputImagem = document.getElementById("inputImagem");
    const previewContainer = document.getElementById("previewContainer");
    const previewImagem = document.getElementById("previewImagem");
    const btnRemoverImagem = document.getElementById("btnRemoverImagem");

    const btnAbrirCamera = document.getElementById("btnAbrirCamera");
    const btnFecharCamera = document.getElementById("btnFecharCamera");
    const btnCapturarFoto = document.getElementById("btnCapturarFoto");
    const btnTrocarCamera = document.getElementById("btnTrocarCamera");

    const cameraPopup = document.getElementById("cameraPopup");
    const cameraVideo = document.getElementById("cameraVideo");

    let stream = null;
    let currentCameraIndex = 0;
    let videoDevices = [];
    let currentFacingMode = null; // ‚Äúuser‚Äù ou ‚Äúenvironment‚Äù

    // 1) Alternar modo escuro/claro
    toggleModoBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleModoBtn.setAttribute("aria-pressed", isDark);
      toggleModoBtn.querySelector(".texto-modo").textContent = isDark
        ? "Modo Claro"
        : "Modo Escuro";
    });

    // 2) Bot√£o ‚ÄúAn√¥nimo‚Äù: torna o campo somente leitura (readonly)
    btnAnonimo.addEventListener("click", () => {
      if (!inputNome.readOnly) {
        inputNome.value = "An√¥nimo";
        inputNome.readOnly = true;
        btnAnonimo.textContent = "Desfazer An√¥nimo";
        inputNome.classList.add("readonly-style");
      } else {
        inputNome.value = "";
        inputNome.readOnly = false;
        btnAnonimo.textContent = "An√¥nimo?";
        inputNome.classList.remove("readonly-style");
        inputNome.focus();
      }
    });

    // 3) Ao selecionar arquivo manualmente, remova espelhamento no preview
    inputImagem.addEventListener("change", () => {
      previewContainer.classList.remove("invert-camera");
      const file = inputImagem.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImagem.src = e.target.result;
          previewContainer.style.display = "flex";
        };
        reader.readAsDataURL(file);
      }
    });

    // 4) Remover imagem
    btnRemoverImagem.addEventListener("click", () => {
      inputImagem.value = "";
      previewImagem.src = "";
      previewContainer.style.display = "none";
      previewContainer.classList.remove("invert-camera");
    });

    // 5) Envio do formul√°rio
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      try {
        await fetch("http://localhost:3000/upload", {
          method: "POST",
          body: formData,
        });
        form.reset();
        btnRemoverImagem.click();
        if (inputNome.readOnly) {
          inputNome.readOnly = false;
          inputNome.value = "";
          inputNome.classList.remove("readonly-style");
          btnAnonimo.textContent = "An√¥nimo?";
        }
        carregarPessoas();
      } catch (err) {
        console.error("Erro ao enviar dados:", err);
        alert("Ocorreu um erro ao cadastrar. Tente novamente.");
      }
    });

    // 6) Carregar lista de pessoas/relatos (com localizacao e criado_em corrigido)
    async function carregarPessoas() {
      try {
        const res = await fetch("http://localhost:3000/pessoas");
        let pessoas = await res.json();

        pessoas = pessoas
          .map((p) => {
            const pontos = parseInt(localStorage.getItem("pontos_" + p.id)) || 0;
            return { ...p, pontos };
          })
          .sort((a, b) => b.pontos - a.pontos);

        lista.innerHTML = "";

        pessoas.forEach((p) => {
          // Transformar string "YYYY-MM-DD HH:MM:SS" em Date v√°lido:
          let criadoAt = p.criado_em;
          if (typeof criadoAt === "string") {
            criadoAt = criadoAt.replace(" ", "T");
          }
          const dataFormatada = new Date(criadoAt).toLocaleString("pt-BR");

          const li = document.createElement("li");
          li.classList.add("card-pessoa");
          li.innerHTML = `
            <div class="votacao">
              <button class="up btn-voto" data-id="${p.id}" aria-label="Curtir">‚ñ≤</button>
              <span class="score" id="score_${p.id}">${p.pontos}</span>
              <button class="down btn-voto" data-id="${p.id}" aria-label="Descurtir">‚ñº</button>
            </div>
            <strong>${p.nome}</strong>
            <img src="data:image/jpeg;base64,${p.imagem}" alt="Imagem de ${p.nome}" />
            <p>${p.relato}</p>
            <p><em>Localiza√ß√£o:</em> ${p.localizacao}</p>
            <p><em>Criado em:</em> ${dataFormatada}</p>
            <button class="delete-btn" data-id="${p.id}" aria-label="Excluir relato">üóëÔ∏è Excluir</button>
          `;
          lista.appendChild(li);
        });

        // Eventos de vota√ß√£o
        document.querySelectorAll(".btn-voto").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            const key = "pontos_" + id;
            let pontos = parseInt(localStorage.getItem(key)) || 0;
            pontos += e.currentTarget.classList.contains("up") ? 1 : -1;
            if (pontos < 0) pontos = 0;
            localStorage.setItem(key, pontos);
            carregarPessoas();
          });
        });

        // Eventos de exclus√£o
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (confirm("Tem certeza que deseja excluir este cadastro?")) {
              await fetch(`http://localhost:3000/excluir/${id}`, {
                method: "DELETE",
              });
              localStorage.removeItem("pontos_" + id);
              carregarPessoas();
            }
          });
        });
      } catch (err) {
        console.error("Erro ao carregar lista:", err);
      }
    }

    // 7) Obter e iniciar c√¢meras
    async function getVideoDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      videoDevices = devices.filter((d) => d.kind === "videoinput");
    }

    async function startCamera(index) {
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
      }

      const constraints = {
        video: {
          deviceId: { exact: videoDevices[index].deviceId },
        },
        audio: false,
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      cameraVideo.srcObject = stream;

      // Ajusta espelhamento conforme facingMode
      const [track] = stream.getVideoTracks();
      const settings = track.getSettings();
      currentFacingMode = settings.facingMode || null;

      if (currentFacingMode === "user") {
        cameraVideo.style.transform = "scaleX(-1)";
      } else {
        cameraVideo.style.transform = "none";
      }
    }

    // 8) Abrir pop-up da c√¢mera apenas ao clicar em ‚ÄúTirar foto com c√¢mera‚Äù
    btnAbrirCamera.addEventListener("click", async () => {
      try {
        await getVideoDevices();

        if (videoDevices.length === 0) {
          alert("Nenhuma c√¢mera foi encontrada.");
          return;
        }

        currentCameraIndex = 0;
        await startCamera(currentCameraIndex);

        // Exibe o bot√£o de trocar c√¢mera s√≥ se houver mais de uma
        btnTrocarCamera.style.display =
          videoDevices.length > 1 ? "inline-block" : "none";

        cameraPopup.style.display = "flex";
        cameraPopup.setAttribute("aria-hidden", "false");
      } catch (err) {
        alert("Erro ao acessar a c√¢mera.");
        console.error(err);
      }
    });

    // 9) Fechar pop-up da c√¢mera
    btnFecharCamera.addEventListener("click", () => {
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
        stream = null;
      }
      cameraPopup.style.display = "none";
      cameraPopup.setAttribute("aria-hidden", "true");
    });

    // 10) Trocar de c√¢mera
    btnTrocarCamera.addEventListener("click", async () => {
      if (videoDevices.length <= 1) return;
      currentCameraIndex = (currentCameraIndex + 1) % videoDevices.length;
      await startCamera(currentCameraIndex);
    });

    // 11) Capturar foto
    btnCapturarFoto.addEventListener("click", () => {
      if (!stream) return;

      const canvas = document.createElement("canvas");
      canvas.width = cameraVideo.videoWidth;
      canvas.height = cameraVideo.videoHeight;
      const ctx = canvas.getContext("2d");

      if (currentFacingMode === "user") {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

      canvas.toBlob((blob) => {
        const file = new File([blob], "foto.png", { type: "image/png" });
        const dt = new DataTransfer();
        dt.items.add(file);
        inputImagem.files = dt.files;

        previewImagem.src = URL.createObjectURL(blob);
        previewContainer.classList.remove("invert-camera");
        previewContainer.style.display = "flex";

        btnFecharCamera.click();
      }, "image/png");
    });

    // 12) Inicializa lista ao carregar a p√°gina
    window.addEventListener("DOMContentLoaded", carregarPessoas);
  </script>
</body>
</html>
